service: tangotube

image: jmarsh24/tangotube

servers:
  web:
    hosts:
      - 168.119.239.114
    cmd: bundle exec puma -C config/puma.rb
  job:
    hosts:
      - 159.69.149.32
    cmd: bundle exec good_job start
registry:
  username: jmarsh24
  password:
    - KAMAL_REGISTRY_PASSWORD
env:
  clear:
    DB_HOST: 128.140.105.113
  secret:
    - RAILS_MASTER_KEY
    - POSTGRES_PASSWORD

builder:
  args:
    RUBY_VERSION: 3.2.2
    RAILS_ENV: production
    NODE_VERSION: 18.12.0
    YARN_VERSION: 1.22.19
  multiarch: false
  cache:
    type: registry
    image: tangotube-build-cache
    options: mode=max,image-manifest=true,oci-mediatypes=true

accessories:
  db:
    image: postgres:15
    host: 128.140.105.113
    port: 5432
    env:
      clear:
        POSTGRES_USER: "postgres"
        POSTGRES_DB: "tangotube_production"
      secret:
        - POSTGRES_PASSWORD
    files:
      # - config/postgres/production.cnf:/etc/postgresql/my.conf
      - db/production.sql:/docker-entrypoint-initdb.d/setup.sql
    directories:
      - data:/var/lib/postgresql/data

healthcheck:
  path: /up
  port: 3000
